name: Tests

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    test:
        name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]
                python-version: ["3.10"]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Build wheel
              uses: PyO3/maturin-action@v1
              with:
                  command: build
                  args: --out dist
                  sccache: "true"

            - name: Install package and test dependencies
              run: |
                  pip install dist/*.whl
                  pip install pytest

            - name: Run tests
              env:
                  SYMBOLICA_LICENSE_KEY: ${{ secrets.SYMBOLICA_LICENSE_KEY }}
              run: pytest tests/ -v

            - name: Run tests with coverage
              if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
              env:
                  SYMBOLICA_LICENSE_KEY: ${{ secrets.SYMBOLICA_LICENSE_KEY }}
              run: |
                  pip install pytest-cov
                  pytest tests/ --cov=symbolica --cov-report=xml --cov-report=term

            - name: Upload coverage to codecov
              if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
              uses: codecov/codecov-action@v3
              with:
                  files: ./coverage.xml
                  fail_ci_if_error: false
